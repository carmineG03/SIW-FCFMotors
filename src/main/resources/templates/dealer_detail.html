<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8"/>
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/allert.css">
  <link rel="stylesheet" href="/css/styles.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Bungee+Spice&family=Open+Sans:wght@400;600;700&display=swap"/>
  
  <title th:text="${dealer.name} + ' - FCF Motors'">Dettagli Concessionario - FCF Motors</title>
</head>

<body>
<header id="main-header">
  <div class="header-left">
    <a href="/" class="logo-link">
      <div class="logo-container">
        <img th:src="@{/image/logo1.png}" alt="FCF Motors Logo" class="logo"/>
      </div>
    </a>
    <div class="title-container">
      <h1 class="main-title">FCF MOTORS</h1>
    </div>
  </div>
  <div class="nav-container">
    <div class="nav-bar"></div>
  </div>
  <div class="header-right">
    <div class="dropdown">
      <button class="dropdown-toggle" aria-label="Menu">
        <i class="fas fa-bars"></i>
      </button>
      <div class="dropdown-menu">
        <a th:href="@{/products}"><i class="fas fa-car"></i> Trova Auto</a>
        <a th:href="@{/dealers}"><i class="fas fa-map-marker-alt"></i> Concessionari</a>
        <a th:href="@{/cart}"><i class="fas fa-shopping-cart"></i> Carrello</a>
        <a sec:authorize="!isAuthenticated()" th:href="@{/login}"><i class="fas fa-user"></i> Login</a>
        <a sec:authorize="isAuthenticated()" th:href="@{/account}"><i class="fas fa-user"></i> Account</a>
        <a sec:authorize="hasRole('PRIVATE')" th:href="@{/private/maintenance}"><i class="fas fa-tools"></i> Manutenzione Private</a>
        <a sec:authorize="hasRole('DEALER')" th:href="@{/rest/manutenzione/dealer}"><i class="fas fa-cogs"></i> Manutenzione Dealer</a>
        <a sec:authorize="hasRole('ADMIN')" th:href="@{/admin/maintenance}"><i class="fas fa-shield-alt"></i> Manutenzione Admin</a>
      </div>
    </div>
  </div>
</header>

<main>
  <section class="dealer-details-section">
    <!-- Dealer Details -->
    <div class="dealer-content">
      <h2 th:text="${dealer.name} ?: 'Concessionario'">Concessionario</h2>
      <div class="main-image-container">
        <img th:if="${dealer.images != null and not dealer.images.isEmpty()}" th:src="@{'/rest/api/images/' + ${dealer.images[0].id}}" th:alt="'Immagine principale concessionario ' + ${dealer.name}"/>
        <img th:unless="${dealer.images != null and not dealer.images.isEmpty()}" src="/image/default-dealer.jpg" alt="Immagine di default"/>
      </div>
      <div class="thumbnails-container">
        <img th:each="image, iterStat : ${dealer.images}" th:if="${iterStat.index > 0}" th:src="@{'/rest/api/images/' + ${image.id}}" th:alt="'Miniatura concessionario ' + ${dealer.name}" onclick="changeMainImage(this)"/>
      </div>
      <div th:if="${errorMessage != null}" class="alert alert-danger" th:text="${errorMessage}"></div>
      <div class="description-container">
        <div class="description-item">
          <i class="fas fa-info-circle"></i>
          <span th:text="${dealer.description} ?: 'Nessuna descrizione disponibile'"></span>
        </div>
      </div>
      <div class="details-grid">
        <div class="detail-item">
          <i class="fas fa-map-marker-alt"></i>
          <span th:text="${dealer.address} ?: 'Indirizzo non disponibile'"></span>
        </div>
        <div class="detail-item">
          <i class="fas fa-phone"></i>
          <a th:if="${dealer.phone != null}" th:href="'tel:' + ${dealer.phone}" th:attr="aria-label='Chiama ' + ${dealer.phone}" th:text="${dealer.phone}"></a>
          <span th:unless="${dealer.phone != null}" th:text="'Telefono non disponibile'"></span>
        </div>
        <div class="detail-item">
          <i class="fas fa-envelope"></i>
          <a th:if="${dealer.email != null}" th:href="'mailto:' + ${dealer.email}" th:attr="aria-label='Invia email a ' + ${dealer.email}" th:text="${dealer.email}"></a>
          <span th:unless="${dealer.email != null}" th:text="'Email non disponibile'"></span>
        </div>
      </div>
      <a th:if="${dealer.address != null}" th:href="'https://www.google.com/maps/search/?api=1&query=' + ${#strings.escapeXml(dealer.address)}" class="navigate-button" target="_blank" rel="noopener noreferrer">
        <i class="fas fa-directions"></i> Raggiungi con il navigatore
      </a>
    </div>
    <!-- Cars Section -->
    <div class="cars-section">
      <h2>Auto Disponibili</h2>
      <p th:if="${products == null or products.isEmpty()}" class="no-products">Nessuna auto disponibile al momento.</p>
      <p th:if="${products != null}" th:text="'Auto trovate: ' + ${products.size()}" style="text-align: center; color: #666; font-size: 0.9rem; margin-bottom: 20px;"></p>
      <div class="car-grid">
        <div th:each="product : ${products}" class="car-card" th:classappend="${product.isFeatured} ? 'highlighted'" th:data-id="${product.id}">
          <div class="car-image">
            <img th:src="@{'/rest/api/images/' + ${product.images[0].id} ?: '/image/default-car.jpg'}" th:alt="'Immagine ' + ${product.model}"/>
            <span th:if="${product.isFeatured}" class="highlight-badge">In Evidenza</span>
          </div>
          <div class="car-info">
            <h4 th:text="${product.brand} + ' ' + ${product.model} ?: 'Modello non disponibile'"></h4>
            <p class="price" th:text="'€ ' + ${#numbers.formatCurrency(product.price)}"></p>
            <p class="details">
              <span th:if="${product.year != null}" th:text="${product.year} + ' | '"></span>
              <span th:if="${product.mileage != null}" th:text="${#numbers.formatInteger(product.mileage, 0, 'COMMA')} + ' km | '"></span>
              <span th:if="${product.fuelType != null}" th:text="${product.fuelType}"></span>
            </p>
          </div>
          <div class="car-actions">
            <a href="#" class="modern-button view-details" th:data-id="${product.id}">
              <i class="fas fa-eye"></i> Dettagli
            </a>
          </div>
        </div>
      </div>
      <!-- Popups per i dettagli delle auto -->
      <div th:each="product : ${products}" class="car-details-popup" th:id="'popup-' + ${product.id}">
        <div class="car-details-popup-content">
          <span class="close-popup">×</span>
          <h3 th:text="${product.brand} + ' ' + ${product.model} ?: 'Auto'"></h3>
          <div class="carousel">
            <div class="carousel-inner">
              <div th:each="image, iterStat : ${product.images}" class="carousel-item" th:classappend="${iterStat.index == 0} ? 'active' : ''">
                <img th:src="@{'/rest/api/images/' + ${image.id}}" th:alt="'Immagine ' + ${product.model}"/>
              </div>
              <div th:if="${product.images == null or product.images.isEmpty()}" class="carousel-item active">
                <img src="/image/default-car.jpg" th:alt="'Immagine ' + ${product.model}"/>
              </div>
            </div>
            <div class="carousel-thumbnails">
              <img th:each="image, iterStat : ${product.images}" th:src="@{'/rest/api/images/' + ${image.id}}" th:alt="'Immagine ' + ${product.model}" th:classappend="${iterStat.index == 0} ? 'active' : ''" onclick="showImage(this, event)"/>
            </div>
            <button class="carousel-control-prev" onclick="prevImage(event)">❮</button>
            <button class="carousel-control-next" onclick="nextImage(event)">❯</button>
          </div>
          <div class="detail-field">
            <label><i class="fas fa-euro-sign"></i> Prezzo</label>
            <p th:text="'€ ' + ${#numbers.formatCurrency(product.price)}"></p>
          </div>
          <div class="detail-field">
            <label><i class="fas fa-calendar-alt"></i> Anno</label>
            <p th:text="${product.year} ?: 'Non specificato'"></p>
          </div>
          <div class="detail-field">
            <label><i class="fas fa-tachometer-alt"></i> Chilometraggio</label>
            <p th:text="${product.mileage != null} ? ${#numbers.formatInteger(product.mileage, 0, 'COMMA')} + ' km' : 'Non specificato'"></p>
          </div>
          <div class="detail-field">
            <label><i class="fas fa-gas-pump"></i> Tipo di carburante</label>
            <p th:text="${product.fuelType} ?: 'Non specificato'"></p>
          </div>
          <div class="detail-field">
            <label><i class="fas fa-cogs"></i> Trasmissione</label>
            <p th:text="${product.transmission} ?: 'Non specificato'"></p>
          </div>
          <div class="detail-field">
            <label><i class="fas fa-info-circle"></i> Descrizione</label>
            <p th:text="${product.description} ?: 'Nessuna descrizione disponibile'"></p>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<footer>
  <div class="footer-content">
    <div class="footer-section">
      <h4>Link Utili</h4>
      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/products">Trova Auto</a></li>
        <li><a href="/dealers">Concessionari</a></li>
        <li><a href="/cart">Carrello</a></li>
      </ul>
    </div>
    <div class="footer-section">
      <h4>Contatti</h4>
      <p>Email: info@fcfmotors.com</p>
      <p>Telefono: +39 123 456 7890</p>
      <p>Indirizzo: Via Auto, 123, Milano, Italia</p>
    </div>
    <div class="footer-section">
      <h4>Seguici</h4>
      <div class="social-links">
        <a href="https://facebook.com" target="_blank" class="social-icon"><i class="fab fa-facebook-f"></i></a>
        <a href="https://instagram.com" target="_blank" class="social-icon"><i class="fab fa-instagram"></i></a>
        <a href="https://twitter.com" target="_blank" class="social-icon"><i class="fab fa-twitter"></i></a>
      </div>
    </div>
    <div class="footer-section">
      <h4>Informazioni</h4>
      <p>FCF Motors offre una vasta gamma di auto nuove e usate. Scopri la tua prossima auto con noi!</p>
    </div>
  </div>
  <div class="footer-bottom">
    <p>© 2025 FCF Motors. Tutti i diritti riservati.</p>
  </div>
</footer>

<script>
  // Gestione del menu a tendina
  document.addEventListener('click', function(event) {
    const dropdownToggle = event.target.closest('.dropdown-toggle');
    const dropdownMenu = document.querySelector('.dropdown-menu');

    if (!dropdownToggle || !dropdownMenu) return;

    if (dropdownToggle) {
      event.stopPropagation();
      const isOpen = dropdownMenu.classList.contains('show');
      dropdownMenu.classList.toggle('show', !isOpen);
      dropdownToggle.classList.toggle('open', !isOpen);
      return;
    }

    if (!dropdownMenu.contains(event.target)) {
      dropdownMenu.classList.remove('show');
      const toggleButton = document.querySelector('.dropdown-toggle');
      if (toggleButton) toggleButton.classList.remove('open');
    }
  });

  document.addEventListener('keydown', function(event) {
    const dropdownToggle = event.target.closest('.dropdown-toggle');
    const dropdownMenu = document.querySelector('.dropdown-menu');

    if (!dropdownToggle || !dropdownMenu) return;

    if ((event.key === 'Enter' || event.key === ' ') && event.target === dropdownToggle) {
      event.preventDefault();
      const isOpen = dropdownMenu.classList.contains('show');
      dropdownMenu.classList.toggle('show', !isOpen);
      dropdownToggle.classList.toggle('open', !isOpen);
    }
  });

  // Funzione per cambiare l'immagine principale
  function changeMainImage(thumbnail) {
    const mainImage = document.querySelector('.main-image-container img');
    mainImage.src = thumbnail.src;
    mainImage.alt = thumbnail.alt;
  }

  // Gestione del popup
  document.addEventListener('click', function(event) {
    const viewDetailsButton = event.target.closest('.view-details');
    const closePopup = event.target.closest('.close-popup');
    const popups = document.querySelectorAll('.car-details-popup');

    if (viewDetailsButton) {
      event.preventDefault();
      const productId = viewDetailsButton.getAttribute('data-id');
      const popup = document.getElementById(`popup-${productId}`);
      if (popup) {
        popups.forEach(p => p.classList.remove('show'));
        popup.classList.add('show');
        initializeCarousel(popup);
      } else {
        console.error(`Popup with ID popup-${productId} not found`);
      }
    }

    if (closePopup) {
      popups.forEach(p => p.classList.remove('show'));
    } else {
      popups.forEach(popup => {
        if (event.target === popup && !popup.querySelector('.car-details-popup-content').contains(event.target)) {
          popup.classList.remove('show');
        }
      });
    }
  });

  // Chiusura del popup con il tasto Esc
  document.addEventListener('keydown', function(event) {
    const popups = document.querySelectorAll('.car-details-popup');
    if (event.key === 'Escape') {
      popups.forEach(p => p.classList.remove('show'));
    }
  });

  // Funzione per inizializzare il carosello in ogni popup
  function initializeCarousel(popup) {
    const carousel = popup.querySelector('.carousel');
    if (!carousel) return;

    let currentIndex = 0;
    const items = carousel.querySelectorAll('.carousel-item');
    const thumbnails = carousel.querySelectorAll('.carousel-thumbnails img');
    const prevBtn = carousel.querySelector('.carousel-control-prev');
    const nextBtn = carousel.querySelector('.carousel-control-next');

    if (items.length <= 1 || !prevBtn || !nextBtn) {
      if (prevBtn) prevBtn.style.display = 'none';
      if (nextBtn) nextBtn.style.display = 'none';
      return;
    }

    const updateCarousel = () => {
      items.forEach((item, index) => {
        item.classList.toggle('active', index === currentIndex);
      });
      thumbnails.forEach((thumb, index) => {
        thumb.classList.toggle('active', index === currentIndex);
      });
    };

    prevBtn.addEventListener('click', (event) => {
      event.stopPropagation();
      currentIndex = currentIndex > 0 ? currentIndex - 1 : items.length - 1;
      updateCarousel();
    });

    nextBtn.addEventListener('click', (event) => {
      event.stopPropagation();
      currentIndex = currentIndex < items.length - 1 ? currentIndex + 1 : 0;
      updateCarousel();
    });

    thumbnails.forEach((thumb, index) => {
      thumb.addEventListener('click', (event) => {
        event.stopPropagation();
        currentIndex = index;
        updateCarousel();
      });
    });

    updateCarousel();
  }

  // Inizializza i caroselli per ogni popup all'avvio
  document.querySelectorAll('.car-details-popup').forEach(popup => {
    initializeCarousel(popup);
  });
</script>
</body>
</html>