<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Modifica Auto - FCF Motors</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/alerts.css">
    <link rel="stylesheet" href="/css/maintenance.css">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Bungee+Spice&display=swap">
</head>

<body class="maintenance-page">

<header id="main-header">
    <div class="header-left">
        <a href="/" class="logo-link">
            <div class="logo-container">
                <img th:src="@{/image/logo1.png}" alt="FCF Motors Logo" class="logo"/>
            </div>
        </a>
        <div class="title-container">
            <h1 class="main-title">FCF MOTORS</h1>
        </div>
    </div>
    <div class="header-right">
        <div class="dropdown">
            <button class="dropdown-toggle" aria-label="Menu">
                <i class="fas fa-bars"></i>
            </button>
            <div class="dropdown-menu">
                <a th:href="@{/products}"><i class="fas fa-car"></i> Trova Auto</a>
                <a th:href="@{/dealers}"><i class="fas fa-map-marker-alt"></i> Concessionari</a>
                <a th:href="@{/cart}"><i class="fas fa-shopping-cart"></i> Carrello</a>
                <a th:href="@{/account}"><i class="fas fa-user"></i> Account</a>
            </div>
        </div>
    </div>
</header>

<main>
    <div class="container">
        <div class="page-header">
            <h1><i class="fas fa-edit"></i> Modifica la Tua Auto</h1>
            <p>Aggiorna le informazioni e le immagini della tua auto</p>
        </div>

        <!-- Messaggi di feedback -->
        <div th:if="${param.error}" class="alert alert-danger">
            <strong><i class="fas fa-exclamation-triangle"></i> Errore:</strong>
            <span th:switch="${param.error}">
                <span th:case="'not_authorized'">Non sei autorizzato a modificare questa auto!</span>
                <span th:case="'update_failed'">Impossibile aggiornare l'auto!</span>
                <span th:case="'invalid_price'">Il prezzo deve essere maggiore di 0!</span>
                <span th:case="'invalid_year'">Anno non valido!</span>
                <span th:case="'invalid_mileage'">Chilometraggio non valido!</span>
                <span th:case="'missing_fields'">Compila tutti i campi obbligatori!</span>
                <span th:case="'image_error'">Errore durante l'elaborazione delle immagini!</span>
                <span th:case="*">Si è verificato un errore!</span>
            </span>
        </div>

    
        <!-- Panoramica Auto Corrente -->
        <div id="car-overview" class="maintenance-section">
            <h2><i class="fas fa-car"></i> La Tua Auto Attuale</h2>
            
            <!-- Carosello immagini auto -->
            <div th:if="${product.images != null and !product.images.isEmpty()}" class="image-carousel">
                <div th:each="image, iterStat : ${product.images}" 
                     th:class="${iterStat.index == 0} ? 'image-item active' : 'image-item'">
                    <img th:src="@{'/images/' + ${image.id}}" th:alt="'Immagine ' + ${iterStat.index + 1}"/>
                </div>
                <div th:if="${#lists.size(product.images) > 1}" class="carousel-nav">
                    <button class="carousel-btn prev" onclick="changeCarImage(-1)"><i class="fas fa-chevron-left"></i></button>
                    <button class="carousel-btn next" onclick="changeCarImage(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div th:if="${#lists.size(product.images) > 1}" class="carousel-dots">
                    <span th:each="image, iterStat : ${product.images}" 
                          th:class="${iterStat.index == 0} ? 'carousel-dot active' : 'carousel-dot'"
                          th:onclick="'setCarImage(' + ${iterStat.index} + ')'"></span>
                </div>
            </div>
            
            <!-- Se non ci sono immagini -->
            <div th:unless="${product.images != null and !product.images.isEmpty()}" class="image-carousel">
                <div class="image-item active" style="display: flex; align-items: center; justify-content: center; height: 300px; background: rgba(245, 166, 35, 0.1); border: 2px dashed rgba(245, 166, 35, 0.5); border-radius: 10px;">
                    <div style="text-align: center; color: #F5A623; font-size: 1.1rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                        Nessuna immagine disponibile
                    </div>
                </div>
            </div>
            
            <div class="info-grid">
                <div class="info-item">
                    <div class="label"><i class="fas fa-industry"></i> Marca</div>
                    <div class="value" th:text="${product != null ? product.brand : 'N/A'}">N/A</div>
                </div>
                
                <div class="info-item">
                    <div class="label"><i class="fas fa-car-side"></i> Modello</div>
                    <div class="value" th:text="${product != null ? product.model : 'N/A'}">N/A</div>
                </div>
                
                <div class="info-item">
                    <div class="label"><i class="fas fa-tags"></i> Categoria</div>
                    <div class="value" th:text="${product != null ? product.category : 'N/A'}">N/A</div>
                </div>
                
                <div class="info-item">
                    <div class="label"><i class="fas fa-euro-sign"></i> Prezzo</div>
                    <div class="value" th:text="${product != null ? '€ ' + #numbers.formatDecimal(product.price, 1, 'COMMA', 2, 'POINT') : 'N/A'}">N/A</div>
                </div>
                
                <div class="info-item">
                    <div class="label"><i class="fas fa-calendar-alt"></i> Anno</div>
                    <div class="value" th:text="${product != null ? product.year : 'N/A'}">N/A</div>
                </div>
                
                <div class="info-item">
                    <div class="label"><i class="fas fa-tachometer-alt"></i> Chilometraggio</div>
                    <div class="value" th:text="${product != null ? #numbers.formatDecimal(product.mileage, 1, 'COMMA', 0, 'POINT') + ' km' : 'N/A'}">N/A</div>
                </div>
                
                <div class="info-item">
                    <div class="label"><i class="fas fa-gas-pump"></i> Carburante</div>
                    <div class="value" th:text="${product != null ? product.fuelType : 'N/A'}">N/A</div>
                </div>
                
                <div class="info-item">
                    <div class="label"><i class="fas fa-cogs"></i> Trasmissione</div>
                    <div class="value" th:text="${product != null ? product.transmission : 'N/A'}">N/A</div>
                </div>
            </div>

            <!-- Descrizione separata -->
            <div class="info-item" style="margin-top: 20px;">
                <div class="label"><i class="fas fa-align-left"></i> Descrizione</div>
                <div class="value" th:text="${product != null ? product.description : 'N/A'}" style="line-height: 1.6;">N/A</div>
            </div>

            <!-- Pulsanti di azione -->
            <div class="action-buttons">
                <button id="edit-btn" class="maintenance-btn btn-primary">
                    <i class="fas fa-edit"></i> Modifica Auto
                </button>
                
                <a th:href="@{/private/messages}" class="maintenance-btn btn-secondary">
                    <i class="fas fa-envelope"></i> Visualizza Messaggi
                </a>
                
                <form th:action="@{/private/delete/{id}(id=${product.id})}" method="post" style="display: inline;">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="maintenance-btn btn-danger" 
                            onclick="return confirm('Sei sicuro di voler eliminare questa auto? Questa azione non può essere annullata.');">
                        <i class="fas fa-trash"></i> Elimina Auto
                    </button>
                </form>
                
                <a th:href="@{/account}" class="maintenance-btn">
                    <i class="fas fa-arrow-left"></i> Torna al Profilo
                </a>
            </div>
        </div>

        <!-- Form di Modifica -->
        <div id="edit-form" class="maintenance-section" style="display: none;">
            <h2><i class="fas fa-edit"></i> Modifica Auto</h2>
            
            <form th:action="@{/private/edit/{id}(id=${product.id})}" method="post" th:object="${product}" enctype="multipart/form-data" class="maintenance-form">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                
                <!-- Informazioni Base -->
                <div class="form-section">
                    <h3><i class="fas fa-info-circle"></i> Informazioni Base</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="brand"><i class="fas fa-industry"></i> Marca *</label>
                            <input type="text" id="brand" th:field="*{brand}" required maxlength="50" placeholder="Es. BMW, Audi, Ford..."/>
                        </div>
                        <div class="form-group">
                            <label for="model"><i class="fas fa-car-side"></i> Modello *</label>
                            <input type="text" id="model" th:field="*{model}" required maxlength="50" placeholder="Es. Serie 3, A4, Focus..."/>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="category"><i class="fas fa-tags"></i> Categoria *</label>
                            <select id="category" th:field="*{category}" required>
                                <option value="">Seleziona categoria</option>
                                <option value="City Car">City Car</option>
                                <option value="Utilitaria">Utilitaria</option>
                                <option value="Berlina">Berlina</option>
                                <option value="Station Wagon">Station Wagon</option>
                                <option value="SUV">SUV</option>
                                <option value="Crossover">Crossover</option>
                                <option value="Coupé">Coupé</option>
                                <option value="Cabrio">Cabrio</option>
                                <option value="Monovolume">Monovolume</option>
                                <option value="Pick-up">Pick-up</option>
                                <option value="Sportiva">Sportiva</option>
                                <option value="Elettrica">Elettrica</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="price"><i class="fas fa-euro-sign"></i> Prezzo (€) *</label>
                            <input type="number" id="price" th:field="*{price}" required min="1" max="999999" step="0.01" placeholder="25000"/>
                        </div>
                    </div>
                </div>

                <!-- Dettagli Tecnici -->
                <div class="form-section">
                    <h3><i class="fas fa-cogs"></i> Dettagli Tecnici</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="year"><i class="fas fa-calendar-alt"></i> Anno *</label>
                            <input type="number" id="year" th:field="*{year}" required min="1900" max="2030" placeholder="2020"/>
                        </div>
                        <div class="form-group">
                            <label for="mileage"><i class="fas fa-tachometer-alt"></i> Chilometraggio *</label>
                            <input type="number" id="mileage" th:field="*{mileage}" required min="0" max="9999999" placeholder="50000"/>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="fuelType"><i class="fas fa-gas-pump"></i> Carburante *</label>
                            <select id="fuelType" th:field="*{fuelType}" required>
                                <option value="">Seleziona carburante</option>
                                <option value="Benzina">Benzina</option>
                                <option value="Diesel">Diesel</option>
                                <option value="Elettrico">Elettrico</option>
                                <option value="Ibrido">Ibrido</option>
                                <option value="GPL">GPL</option>
                                <option value="Metano">Metano</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="transmission"><i class="fas fa-cogs"></i> Trasmissione *</label>
                            <select id="transmission" th:field="*{transmission}" required>
                                <option value="">Seleziona trasmissione</option>
                                <option value="Manuale">Manuale</option>
                                <option value="Automatica">Automatica</option>
                                <option value="Semi-automatica">Semi-automatica</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Descrizione -->
                <div class="form-section">
                    <h3><i class="fas fa-align-left"></i> Descrizione</h3>
                    
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="description"><i class="fas fa-pen"></i> Descrizione Auto *</label>
                            <textarea id="description" th:field="*{description}" required maxlength="2000" rows="5"
                                      placeholder="Aggiorna la descrizione della tua auto: condizioni generali, optional installati, storia del veicolo, eventuali danni o riparazioni, ecc..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Gestione Immagini -->
                <div class="form-section images-section">
                    <h3><i class="fas fa-images"></i> Gestione Immagini</h3>
                    
                    <!-- Immagini attuali -->
                    <div class="image-management">
                        <h4 style="color: #F5A623; margin-bottom: 15px; font-size: 1.2rem;">
                            <i class="fas fa-photo-video"></i> Immagini Attuali
                        </h4>
                        
                        <div th:if="${product.images != null and !product.images.isEmpty()}" class="current-images">
                            <div th:each="image : ${product.images}" class="current-image-item">
                                <img th:src="@{'/images/' + ${image.id}}" th:alt="'Immagine auto'" />
                                <button type="button" class="delete-image-btn" 
                                        th:onclick="'deleteImage(' + ${image.id} + ')'"
                                        title="Elimina immagine">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div th:unless="${product.images != null and !product.images.isEmpty()}" class="empty-state" style="margin: 20px 0;">
                            <i class="fas fa-images"></i>
                            <p>Nessuna immagine presente</p>
                        </div>
                    </div>

                    <!-- Upload nuove immagini -->
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="new-images"><i class="fas fa-cloud-upload-alt"></i> Aggiungi/Sostituisci Immagini</label>
                            <div class="file-upload">
                                <input type="file" id="new-images" name="newImages" multiple accept="image/*" onchange="previewNewImages(this)"/>
                                <label for="new-images">
                                    <i class="fas fa-cloud-upload-alt"></i><br>
                                    Clicca per aggiungere o sostituire immagini<br>
                                    <small>Formati: JPG, PNG, GIF (max 5MB ciascuna, max 10 totali)</small>
                                </label>
                            </div>
                            
                            <!-- Preview nuove immagini -->
                            <div id="new-images-preview" class="preview-container"></div>
                        </div>
                    </div>
                </div>

                <!-- Pulsanti -->
                <div class="action-buttons">
                    <button type="submit" class="maintenance-btn btn-success">
                        <i class="fas fa-save"></i> Salva Modifiche
                        <span class="spinner" id="saveSpinner"></span>
                    </button>
                    
                    <button type="button" id="cancel-btn" class="maintenance-btn btn-secondary">
                        <i class="fas fa-times"></i> Annulla
                    </button>
                </div>
            </form>
        </div>
    </div>
</main>

<footer>
    <div class="footer-content">
        <div class="footer-section">
            <h4>Navigazione</h4>
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/products">Trova Auto</a></li>
                <li><a href="/dealers">Concessionari</a></li>
                <li><a href="/cart">Carrello</a></li>
            </ul>
        </div>
        <div class="footer-section">
            <h4>Servizi</h4>
            <ul>
                <li><a href="/services">Finanziamenti</a></li>
                <li><a href="/services">Assicurazioni</a></li>
                <li><a href="/services">Garanzie</a></li>
                <li><a href="/services">Assistenza</a></li>
            </ul>
        </div>
        <div class="footer-section">
            <h4>Supporto</h4>
            <ul>
                <li><a href="/contact">Contattaci</a></li>
                <li><a href="/help">Centro Aiuto</a></li>
                <li><a href="/privacy">Privacy Policy</a></li>
                <li><a href="/terms">Termini di Servizio</a></li>
            </ul>
        </div>
        <div class="footer-section">
            <h4>Contatti</h4>
            <p>Email: info@fcfmotors.com</p>
            <p>Telefono: +39 123 456 7890</p>
            <p>Indirizzo: Via Auto, 123, Milano, Italia</p>
        </div>
    </div>
    <div class="footer-bottom">
        <p>© 2025 FCF Motors. Tutti i diritti riservati.</p>
    </div>
</footer>

<!-- Toast notification -->
<div id="toast" class="toast" style="position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 8px; color: white; font-weight: bold; z-index: 3000; opacity: 0; transition: opacity 0.3s ease; transform: translateY(-10px);"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Dropdown functionality
    const dropdownToggle = document.querySelector('.dropdown-toggle');
    const dropdownMenu = document.querySelector('.dropdown-menu');

    if (dropdownToggle && dropdownMenu) {
        dropdownToggle.addEventListener('click', function() {
            const isOpen = dropdownMenu.classList.contains('show');
            dropdownMenu.classList.toggle('show');
            dropdownToggle.classList.toggle('open', !isOpen);
        });

        document.addEventListener('click', function(event) {
            if (!dropdownToggle.contains(event.target) && !dropdownMenu.contains(event.target)) {
                dropdownMenu.classList.remove('show');
                dropdownToggle.classList.remove('open');
            }
        });

        dropdownToggle.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                dropdownMenu.classList.toggle('show');
                dropdownToggle.classList.toggle('open');
            }
        });
    }

    // Elements
    const editBtn = document.getElementById('edit-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const carOverview = document.getElementById('car-overview');
    const editForm = document.getElementById('edit-form');
    const saveSpinner = document.getElementById('saveSpinner');
    const form = editForm?.querySelector('form');

    // Show/hide edit form
    if (editBtn && carOverview && editForm) {
        editBtn.addEventListener('click', function() {
            carOverview.style.display = 'none';
            editForm.style.display = 'block';
        });
    }

    if (cancelBtn && carOverview && editForm) {
        cancelBtn.addEventListener('click', function() {
            editForm.style.display = 'none';
            carOverview.style.display = 'block';
        });
    }

    // Form validation and submission
    if (form) {
        form.addEventListener('submit', function(e) {
            const price = parseFloat(document.getElementById('price').value);
            if (isNaN(price) || price <= 0) {
                showToast('Il prezzo deve essere maggiore di 0', 'error');
                e.preventDefault();
                return false;
            }

            const year = parseInt(document.getElementById('year').value);
            const currentYear = new Date().getFullYear();
            if (isNaN(year) || year < 1900 || year > currentYear + 1) {
                showToast(`L'anno deve essere compreso tra 1900 e ${currentYear + 1}`, 'error');
                e.preventDefault();
                return false;
            }

            const mileage = parseInt(document.getElementById('mileage').value);
            if (isNaN(mileage) || mileage < 0) {
                showToast('Il chilometraggio non può essere negativo', 'error');
                e.preventDefault();
                return false;
            }

            // Show loading state
            if (saveSpinner) {
                saveSpinner.classList.add('active');
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando... <span class="spinner active"></span>';
                }
            }

            return true;
        });
    }

    // Auto-trim form fields
    ['brand', 'model', 'description'].forEach(fieldName => {
        const field = document.getElementById(fieldName);
        if (field) {
            field.addEventListener('blur', function() {
                this.value = this.value.trim();
            });
        }
    });

    // Initialize carousel
    initializeCarousels();
});

// Toast notification function
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    if (toast) {
        toast.textContent = message;
        toast.style.background = type === 'success' ? 
            'linear-gradient(45deg, #28a745, #218838)' : 
            'linear-gradient(45deg, #dc3545, #c82333)';
        toast.style.opacity = '1';
        toast.style.transform = 'translateY(0)';
        
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(-10px)';
        }, 3000);
    }
}

// Carousel functionality for car images
let currentCarImageIndex = 0;
const carImages = document.querySelectorAll('.image-carousel .image-item');
const carDots = document.querySelectorAll('.carousel-dot');

function initializeCarousels() {
    // Initialize main car carousel
    updateCarImageCarousel();
}

function updateCarImageCarousel() {
    carImages.forEach((img, index) => {
        img.classList.toggle('active', index === currentCarImageIndex);
    });
    carDots.forEach((dot, index) => {
        dot.classList.toggle('active', index === currentCarImageIndex);
    });
}

function changeCarImage(direction) {
    if (carImages.length > 1) {
        currentCarImageIndex += direction;
        if (currentCarImageIndex >= carImages.length) currentCarImageIndex = 0;
        if (currentCarImageIndex < 0) currentCarImageIndex = carImages.length - 1;
        updateCarImageCarousel();
    }
}

function setCarImage(index) {
    if (carImages.length > 1) {
        currentCarImageIndex = index;
        updateCarImageCarousel();
    }
}

// Delete image function
function deleteImage(imageId) {
    if (confirm('Sei sicuro di voler eliminare questa immagine?')) {
        // Create hidden form
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/private/images/delete/${imageId}`;
        
        // Add CSRF token
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = document.querySelector('meta[name="_csrf_parameter"]')?.getAttribute('content') || '_csrf';
        csrfInput.value = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || '';
        form.appendChild(csrfInput);
        
        // Submit form
        document.body.appendChild(form);
        form.submit();
    }
}

// Preview new images function
function previewNewImages(input) {
    const previewContainer = document.getElementById('new-images-preview');
    const files = Array.from(input.files);
    
    previewContainer.innerHTML = '';
    
    if (files.length > 10) {
        showToast('Puoi caricare massimo 10 immagini', 'error');
        input.value = '';
        return;
    }
    
    files.forEach((file, index) => {
        if (file.size > 5 * 1024 * 1024) {
            showToast(`L'immagine ${file.name} è troppo grande (max 5MB)`, 'error');
            return;
        }
        
        if (!file.type.startsWith('image/')) {
            showToast(`Il file ${file.name} non è un'immagine valida`, 'error');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            previewItem.innerHTML = `
                <img src="${e.target.result}" alt="Anteprima ${index + 1}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px;">
                <button type="button" class="remove-btn" onclick="removeNewImage(${index})" title="Rimuovi immagine">
                    <i class="fas fa-times"></i>
                </button>
            `;
            previewContainer.appendChild(previewItem);
        };
        reader.readAsDataURL(file);
    });

    // Update label text
    const label = document.querySelector('label[for="new-images"]');
    if (files.length > 0 && label) {
        label.innerHTML = `<i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 10px; color: #4caf50;"></i><br>
                          ${files.length} immagine${files.length > 1 ? 'i' : ''} selezionata${files.length > 1 ? 'e' : ''}<br>
                          <small>Clicca per cambiare selezione</small>`;
    }
}

// Remove new image from preview
function removeNewImage(index) {
    const fileInput = document.getElementById('new-images');
    const dt = new DataTransfer();
    const files = Array.from(fileInput.files);
    
    files.forEach((file, i) => {
        if (i !== index) {
            dt.items.add(file);
        }
    });
    
    fileInput.files = dt.files;
    previewNewImages(fileInput);
    
    // Reset label if no files
    if (fileInput.files.length === 0) {
        const label = document.querySelector('label[for="new-images"]');
        if (label) {
            label.innerHTML = `<i class="fas fa-cloud-upload-alt"></i><br>
                              Clicca per aggiungere o sostituire immagini<br>
                              <small>Formati: JPG, PNG, GIF (max 5MB ciascuna, max 10 totali)</small>`;
        }
    }
}

// Handle success/error messages on page load
window.addEventListener('load', function() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success')) {
        showToast('Auto aggiornata con successo!', 'success');
    } else if (urlParams.get('error')) {
        const errorParam = urlParams.get('error');
        let errorMessage = 'Si è verificato un errore';
        
        switch(errorParam) {
            case 'not_authorized': errorMessage = 'Non sei autorizzato a modificare questa auto!'; break;
            case 'update_failed': errorMessage = 'Impossibile aggiornare l\'auto!'; break;
            case 'invalid_price': errorMessage = 'Il prezzo deve essere maggiore di 0!'; break;
            case 'invalid_year': errorMessage = 'Anno non valido!'; break;
            case 'invalid_mileage': errorMessage = 'Chilometraggio non valido!'; break;
            case 'missing_fields': errorMessage = 'Compila tutti i campi obbligatori!'; break;
            case 'image_error': errorMessage = 'Errore durante l\'elaborazione delle immagini!'; break;
        }
        
        showToast(errorMessage, 'error');
    }
});
</script>
</body>
</html>